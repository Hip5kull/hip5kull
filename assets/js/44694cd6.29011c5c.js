"use strict";(self.webpackChunkgithub_page=self.webpackChunkgithub_page||[]).push([[397],{3371:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>d});var s=a(4848),r=a(8453);const t={},l="Installation Prometheus/Graphana",i={id:"Monitoring/Prometheus-Grafana",title:"Installation Prometheus/Graphana",description:"Create a Debian12 VM",source:"@site/docs/Monitoring/Prometheus-Grafana.md",sourceDirName:"Monitoring",slug:"/Monitoring/Prometheus-Grafana",permalink:"/hip5kull/docs/Monitoring/Prometheus-Grafana",draft:!1,unlisted:!1,editUrl:"https://github.com/Hip5kull/hip5kull/tree/main/docs/Monitoring/Prometheus-Grafana.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Accueil",permalink:"/hip5kull/docs/intro"},next:{title:"Scripting Shell",permalink:"/hip5kull/docs/Scripting/Bash/scripting-shell"}},o={},d=[{value:"Create a Debian12 VM",id:"create-a-debian12-vm",level:2},{value:"Prometheus Installation",id:"prometheus-installation",level:2},{value:"Installation Grafana",id:"installation-grafana",level:2},{value:"Installation Prometheus_exporter",id:"installation-prometheus_exporter",level:2},{value:"Proxmox node01",id:"proxmox-node01",level:3},{value:"Exporter&#39;s Installation",id:"exporters-installation",level:3},{value:"Firewall Rules",id:"firewall-rules",level:2},{value:"Dashboard Grafana",id:"dashboard-grafana",level:2},{value:"Add Datasources",id:"add-datasources",level:3},{value:"Import Dashboard",id:"import-dashboard",level:3}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"installation-prometheusgraphana",children:"Installation Prometheus/Graphana"}),"\n",(0,s.jsx)(n.h2,{id:"create-a-debian12-vm",children:"Create a Debian12 VM"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"To create Debian12 VM on the Proxmox Cluster"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"qm create <vm_id> \\\n  --name <vm_name> \\\n  --sockets 1 \\\n  --cores <vm_cpus> \\\n  --memory <vm_mem_mb> \\\n  --net0 virtio,bridge=<vm_bridge>\n\nqm disk import <vm_id> /mnt/pve/cfs-common-install/template/iso/debian-12-generic-amd64.img vms-<(infra|prod|)> -format raw\n\nqm set <vm_id> --scsihw virtio-scsi-pci --scsi0 vms-<(infra|prod)>:vm-<vm_id>-disk-0\n\nqm resize <vm_id> scsi0 +xG # Replace x with a number to resize debian disk\n\nqm set <vm_id> --ide2 vms-<(infra|prod)>:cloudinit\n\nqm set <vm_id> --boot c --bootdisk scsi0\n"})}),"\n",(0,s.jsx)(n.h2,{id:"prometheus-installation",children:"Prometheus Installation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Download prometheus"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"wget https://github.com/prometheus/prometheus/releases/download/v2.46.0/prometheus-2.46.0.linux-amd64.tar.gz\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Extract archive"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo tar xzf prometheus-2.46.0.linux-amd64.tar.gz\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Move prometheus archive from ~ to  /usr/share/"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo mv prometheus-2.46.0.linux-amd64/ /usr/share/prometheus\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Add prometheus user"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo useradd -u 3434 -d /usr/share/prometheus -s /bin/false prometheus\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"Create data directory"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo mkdir -p /var/lib/prometheus/data\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"6",children:["\n",(0,s.jsx)(n.li,{children:"Change data's owner"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo chown prometheus:prometheus /var/lib/prometheus/data\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"7",children:["\n",(0,s.jsx)(n.li,{children:"Change prometheus' directory owner"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo chown -R prometheus:prometheus /usr/share/prometheus\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"8",children:["\n",(0,s.jsx)(n.li,{children:"Check if that's all right"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"/usr/share/prometheus/prometheus --config.file=/usr/share/prometheus/prometheus.yml\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"9",children:["\n",(0,s.jsx)(n.li,{children:"Create prometheus.service into SystemD"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo vim /etc/systemd/system/prometheus.service\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[Unit]\n    Description=Prometheus Server\n    Documentation=https://prometheus.io/docs/introduction/overview/\n    After=network-online.target\n\n    [Service]\n    User=prometheus\n    Restart=on-failure\n    WorkingDirectory=/usr/share/prometheus\n    ExecStart=/usr/share/prometheus/prometheus --config.file=/usr/share/prometheus/prometheus.yml\n\n    [Install]\n    WantedBy=multi-user.target\n\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"10",children:["\n",(0,s.jsx)(n.li,{children:"Reload & Start prometheus.service"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo systemctl daemon-reload\nsudo systemctl enable prometheus\nsudo systemctl start prometheus\nsudo systemctl status prometheus\n\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"11",children:["\n",(0,s.jsx)(n.li,{children:"prometheus.yml configuration"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo vim /usr/share/prometheus/prometheus.yml\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yml",children:"# my global config\nglobal:\n  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          # - alertmanager:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n  - job_name: \"proxmox\"\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: \n        - 10.3.0.2\n        - 10.3.0.3\n        - 10.3.0.4\n    metrics_path: /pve\n    params:\n      module: [default]\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 127.0.0.1:9221\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"12",children:["\n",(0,s.jsx)(n.li,{children:"Restart prometheus.service"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo systemctl restart prometheus.service\n"})}),"\n",(0,s.jsx)(n.h2,{id:"installation-grafana",children:"Installation Grafana"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Download grafana"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.0.0.linux-amd64.tar.gz\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Extract archive"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo tar -zxvf grafana-enterprise-10.0.0.linux-amd64.tar.gz\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Move grafana archive from ~ to  /usr/share/"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo mv grafana-10.0.0/ /usr/share/grafana\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Add prometheus user"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo useradd -d /usr/share/grafana -s /bin/false grafana\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"Create grafana directories"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo mkdir -p /var/lib/grafana/plugins /etc/grafana /var/log/grafana\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"6",children:["\n",(0,s.jsx)(n.li,{children:"Change /var/liv/grafana's owner"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo chown -R grafana:grafana /var/lib/grafana\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"7",children:["\n",(0,s.jsx)(n.li,{children:"Copy grafana-server binary to /usr/sbin/"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo cp /usr/share/grafana/bin/grafana-server /usr/sbin/\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"8",children:["\n",(0,s.jsx)(n.li,{children:"Copy sample.ini to /etc/grafana/grafana.ini"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo cp /usr/share/grafana/conf/sample.ini /etc/grafana/grafana.ini\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"9",children:["\n",(0,s.jsx)(n.li,{children:"Create grafana-server.service"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo vim /etc/default/grafana-server\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"GRAFANA_USER=grafana\nGRAFANA_GROUP=grafana\nGRAFANA_HOME=/usr/share/grafana\nLOG_DIR=/var/log/grafana\nDATA_DIR=/var/lib/grafana\nMAX_OPEN_FILES=10000\nCONF_DIR=/etc/grafana\nCONF_FILE=/etc/grafana/grafana.ini\nRESTART_ON_UPGRADE=true\nPLUGINS_DIR=/var/lib/grafana/plugins\nPROVISIONING_CFG_DIR=/etc/grafana/provisioning\nPID_FILE_DIR=/var/run/grafana\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo vim /etc/systemd/system/grafana-service.service\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[Unit]\nDescription=Grafana instance\nDocumentation=http://docs.grafana.org\nWants=network-online.target\nAfter=network-online.target\nAfter=postgresql.service mariadb.service mysql.service\n\n[Service]\nEnvironmentFile=/etc/default/grafana-server\nUser=grafana\nGroup=grafana\nType=simple\nRestart=on-failure\nWorkingDirectory=/usr/share/grafana/\nRuntimeDirectory=grafana\nRuntimeDirectoryMode=0750\nExecStart=/usr/share/grafana/bin/grafana-server                                     \\\n                            --config=${CONF_FILE}                                   \\\n                            --pidfile=${PID_FILE_DIR}/grafana-server.pid            \\\n                            cfg:default.paths.logs=${LOG_DIR}                       \\\n                            cfg:default.paths.data=${DATA_DIR}                      \\\n                            cfg:default.paths.plugins=${PLUGINS_DIR}                \\\n                            cfg:default.paths.provisioning=${PROVISIONING_CFG_DIR}\n\n\nLimitNOFILE=10000\nTimeoutStopSec=20\nUMask=0027\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo systemctl daemon-reload\nsudo systemctl enable grafana-server\nsudo systemctl start grafana-server\nsudo systemctl status grafana-server\n"})}),"\n",(0,s.jsx)(n.h2,{id:"installation-prometheus_exporter",children:"Installation Prometheus_exporter"}),"\n",(0,s.jsx)(n.h3,{id:"proxmox-node01",children:"Proxmox node01"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"pveum groupadd monitoring -comment 'Monitoring group'\npveum aclmod / -group monitoring -role PVEAuditor\npveum useradd pve_exporter@pve\npveum usermod pve_exporter@pve -group monitoring\npveum passwd pve_exporter@pve\n"})}),"\n",(0,s.jsx)(n.h3,{id:"exporters-installation",children:"Exporter's Installation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Install Python3-Pip package"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo apt install python3-pip\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Install prometheus-pve-exporter"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Without create python virtual environment you can add --break-system-packages to download pve_exporter"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo python3-pip install prometheus-pve-exporter\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo mkdir -p /usr/share/pve_exporter/\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Create /usr/share/pve_exporter/pve_exporter.yml"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yml",children:"default:\n  user: pve_exporter@pve\n  password: y2DYfVzzeJJ0/N0Cplw=\n  verify_ssl: false\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Create pve_exporter.service into systemD"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[Unit]\nDescription=Proxmox VE Prometheus Exporter\nAfter=network.target\nWants=network.target\n\n[Service]\nRestart=on-failure\nWorkingDirectory=/usr/share/pve_exporter\nExecStart=/usr/local/bin/pve_exporter /usr/share/pve_exporter/pve_exporter.yml 9221 127.0.0.1\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"Reload & Start pve_exporter.service"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo systemctl daemon-reload\nsudo systemctl enable pve_exporter\nsudo systemctl start pve_exporter\nsudo systemctl status pve_exporter\n"})}),"\n",(0,s.jsx)(n.h2,{id:"firewall-rules",children:"Firewall Rules"}),"\n",(0,s.jsxs)(n.p,{children:["To allow monitoring, we have to apply rules in the datacenter firewall\n",(0,s.jsx)(n.img,{alt:"firewall_rules",src:a(2760).A+"",width:"1920",height:"590"}),"\n",(0,s.jsx)(n.img,{alt:"firewall_rules",src:a(3890).A+"",width:"1464",height:"618"})]}),"\n",(0,s.jsx)(n.h2,{id:"dashboard-grafana",children:"Dashboard Grafana"}),"\n",(0,s.jsx)(n.h3,{id:"add-datasources",children:"Add Datasources"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(5196).A+"",width:"1246",height:"577"}),"\n",(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(7847).A+"",width:"1075",height:"886"})]}),"\n",(0,s.jsx)(n.h3,{id:"import-dashboard",children:"Import Dashboard"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(3710).A+"",width:"821",height:"675"}),"\n",(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(4069).A+"",width:"1908",height:"462"}),"\n",(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(1180).A+"",width:"961",height:"803"}),"\n",(0,s.jsx)(n.img,{alt:"dashboard_grafana",src:a(6051).A+"",width:"1910",height:"947"})]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},3710:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_dashboard01-a3c341919864e0fb8b76e926545876d2.png"},4069:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_dashboard02-47752298b8fc8f34e0655b4427323e7e.png"},1180:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_dashboard03-aa6bffa0694e0dc54e076ad8b5d9c085.png"},6051:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_dashboard04-f33e37a8a524b9cd5adca823df652563.png"},5196:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_datasources01-706ef5db53ec8b7f5ad1ff700076babf.png"},7847:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/grafana_datasources02-75fdb8c3ba7d2b1c56f68a910ef1d718.png"},2760:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/proxmox_firewall_rules-ec89e6fdc274a65390a7ee935c957900.png"},3890:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/proxmox_firewall_rules02-6c0fdb783773d0b34931c7f14e51cddb.png"},8453:(e,n,a)=>{a.d(n,{R:()=>l,x:()=>i});var s=a(6540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);